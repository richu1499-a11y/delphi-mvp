{% extends 'delphi/base.html' %}

{% block content %}
<div class="container py-2 py-md-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-11">

            <!-- Progress indicator -->
            <div class="mb-3 mb-md-4">
                <small class="text-muted">Question {{ round_item.order }} of {{ total_items }}</small>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary" role="progressbar"
                         style="width: {{ progress_percent }}%;"
                         aria-valuenow="{{ progress_percent }}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                    </div>
                </div>
            </div>

            <!-- Question Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white py-2 py-md-3">
                    <h5 class="mb-0 fs-6 fs-md-5">Question {{ round_item.order }}</h5>
                </div>
                <div class="card-body p-3 p-md-4">

                    <!-- Question Prompt -->
                    <h4 class="mb-4 fs-6 fs-md-5">{{ round_item.item.prompt }}</h4>

                    <form method="post" id="response-form">
                        {% csrf_token %}

                        {% if round_item.item.item_type == 'likert5' %}
                        <!-- LIKERT 5-POINT SCALE -->
                        <div class="likert-scale-container mb-4">
                            <div class="likert-options-wrapper">
                                <div class="likert-option text-center">
                                    <input type="radio" name="value" value="1" id="likert1"
                                           class="btn-check" {% if current_value == '1' %}checked{% endif %}>
                                    <label class="btn btn-outline-danger likert-btn" for="likert1">
                                        <span class="likert-number">1</span>
                                    </label>
                                    <div class="likert-label mt-1 mt-md-2">
                                        <small><strong>Definitely Disagree</strong></small>
                                    </div>
                                </div>
                                <div class="likert-option text-center">
                                    <input type="radio" name="value" value="2" id="likert2"
                                           class="btn-check" {% if current_value == '2' %}checked{% endif %}>
                                    <label class="btn btn-outline-warning likert-btn" for="likert2">
                                        <span class="likert-number">2</span>
                                    </label>
                                    <div class="likert-label mt-1 mt-md-2">
                                        <small><strong>Disagree</strong></small>
                                    </div>
                                </div>
                                <div class="likert-option text-center">
                                    <input type="radio" name="value" value="3" id="likert3"
                                           class="btn-check" {% if current_value == '3' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary likert-btn" for="likert3">
                                        <span class="likert-number">3</span>
                                    </label>
                                    <div class="likert-label mt-1 mt-md-2">
                                        <small><strong>I don't know</strong></small>
                                    </div>
                                </div>
                                <div class="likert-option text-center">
                                    <input type="radio" name="value" value="4" id="likert4"
                                           class="btn-check" {% if current_value == '4' %}checked{% endif %}>
                                    <label class="btn btn-outline-info likert-btn" for="likert4">
                                        <span class="likert-number">4</span>
                                    </label>
                                    <div class="likert-label mt-1 mt-md-2">
                                        <small><strong>Agree</strong></small>
                                    </div>
                                </div>
                                <div class="likert-option text-center">
                                    <input type="radio" name="value" value="5" id="likert5"
                                           class="btn-check" {% if current_value == '5' %}checked{% endif %}>
                                    <label class="btn btn-outline-success likert-btn" for="likert5">
                                        <span class="likert-number">5</span>
                                    </label>
                                    <div class="likert-label mt-1 mt-md-2">
                                        <small><strong>Definitely Agree</strong></small>
                                    </div>
                                </div>
                            </div>
                            <div class="likert-bar mt-3">
                                <div class="likert-gradient"></div>
                            </div>
                        </div>

                        {% elif round_item.item.item_type == 'yesno' %}
                        <!-- YES/NO -->
                        <div class="row justify-content-center mb-4">
                            <div class="col-auto">
                                <div class="btn-group btn-group-lg" role="group">
                                    <input type="radio" name="value" value="yes" id="yes"
                                           class="btn-check" {% if current_value == 'yes' %}checked{% endif %}>
                                    <label class="btn btn-outline-success px-4 px-md-5 py-2 py-md-3" for="yes">Yes</label>
                                    <input type="radio" name="value" value="no" id="no"
                                           class="btn-check" {% if current_value == 'no' %}checked{% endif %}>
                                    <label class="btn btn-outline-danger px-4 px-md-5 py-2 py-md-3" for="no">No</label>
                                </div>
                            </div>
                        </div>

                        {% elif round_item.item.item_type == 'multiple' %}
                        <!-- MULTIPLE CHOICE -->
                        <div class="multiple-choice-container mb-4">
                            {% if round_item.item.option_a %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="A"
                                       id="optionA" {% if current_value == 'A' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionA">
                                    <strong class="text-primary">A.</strong> {{ round_item.item.option_a }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_b %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="B"
                                       id="optionB" {% if current_value == 'B' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionB">
                                    <strong class="text-primary">B.</strong> {{ round_item.item.option_b }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_c %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="C"
                                       id="optionC" {% if current_value == 'C' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionC">
                                    <strong class="text-primary">C.</strong> {{ round_item.item.option_c }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_d %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="D"
                                       id="optionD" {% if current_value == 'D' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionD">
                                    <strong class="text-primary">D.</strong> {{ round_item.item.option_d }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_e %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="E"
                                       id="optionE" {% if current_value == 'E' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionE">
                                    <strong class="text-primary">E.</strong> {{ round_item.item.option_e }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_f %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input mc-option" type="radio" name="value" value="F"
                                       id="optionF" {% if current_value == 'F' %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="optionF">
                                    <strong class="text-primary">F.</strong> {{ round_item.item.option_f }}
                                </label>
                            </div>
                            {% endif %}

                            <!-- Other Text Box -->
                            <div id="other-text-container" class="mt-3" style="display: none;">
                                <label class="form-label"><strong>Please specify:</strong></label>
                                <textarea class="form-control" id="other-text" name="other_text" rows="3"
                                          placeholder="Please enter your response here...">{{ other_text|default:'' }}</textarea>
                            </div>
                        </div>

                        {% elif round_item.item.item_type == 'checkbox' %}
                        <!-- CHECKBOX (Select Multiple) -->
                        <div class="checkbox-container mb-4">
                            <p class="text-muted mb-3"><em>Select all that apply:</em></p>
                            {% if round_item.item.option_a %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="A"
                                       id="checkA" {% if 'A' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkA">
                                    {{ round_item.item.option_a }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_b %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="B"
                                       id="checkB" {% if 'B' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkB">
                                    {{ round_item.item.option_b }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_c %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="C"
                                       id="checkC" {% if 'C' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkC">
                                    {{ round_item.item.option_c }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_d %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="D"
                                       id="checkD" {% if 'D' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkD">
                                    {{ round_item.item.option_d }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_e %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="E"
                                       id="checkE" {% if 'E' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkE">
                                    {{ round_item.item.option_e }}
                                </label>
                            </div>
                            {% endif %}
                            {% if round_item.item.option_f %}
                            <div class="form-check mb-2 mb-md-3 p-2 p-md-3 border rounded option-card">
                                <input class="form-check-input cb-option" type="checkbox" name="checkbox_value" value="F"
                                       id="checkF" {% if 'F' in current_value %}checked{% endif %}>
                                <label class="form-check-label ms-2 option-label" for="checkF">
                                    {{ round_item.item.option_f }}
                                </label>
                            </div>
                            {% endif %}

                            <!-- Other Text Box for Checkbox -->
                            <div id="cb-other-text-container" class="mt-3" style="display: none;">
                                <label class="form-label"><strong>Please specify "Other":</strong></label>
                                <textarea class="form-control" id="cb-other-text" name="cb_other_text" rows="3"
                                          placeholder="Please enter your response here...">{{ cb_other_text|default:'' }}</textarea>
                            </div>
                        </div>

                        {% elif round_item.item.item_type == 'matrix' %}
                        <!-- MATRIX (Checkbox Grid) - Mobile Friendly -->
                        <div class="matrix-container mb-4">
                            <p class="text-muted mb-3"><em>For each factor, select the appropriate classification:</em></p>
                            
                            <!-- Desktop Table View -->
                            <div class="d-none d-lg-block table-responsive">
                                <table class="table table-bordered table-hover matrix-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th class="factor-column">Factor</th>
                                            {% for col in matrix_columns %}
                                            <th class="text-center column-header">{{ col }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in matrix_rows %}
                                        <tr>
                                            <td class="factor-cell">{{ row }}</td>
                                            {% for col in matrix_columns %}
                                            <td class="text-center checkbox-cell">
                                                <input type="checkbox"
                                                       class="form-check-input matrix-checkbox"
                                                       data-row="{{ row }}"
                                                       data-col="{{ col }}">
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Mobile Card View -->
                            <div class="d-lg-none">
                                {% for row in matrix_rows %}
                                <div class="card mb-3 matrix-mobile-card">
                                    <div class="card-header bg-light py-2">
                                        <strong class="small">{{ row }}</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            {% for col in matrix_columns %}
                                            <div class="col-6 col-sm-4">
                                                <div class="form-check">
                                                    <input type="checkbox"
                                                           class="form-check-input matrix-checkbox"
                                                           data-row="{{ row }}"
                                                           data-col="{{ col }}"
                                                           id="mobile_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">
                                                    <label class="form-check-label small" for="mobile_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">
                                                        {{ col }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <input type="hidden" name="value" id="matrix-value" value="{{ current_value|default:'{}' }}">
                        </div>

                        {% elif round_item.item.item_type == 'text' %}
                        <!-- FREE TEXT -->
                        <div class="mb-4">
                            <textarea class="form-control" name="value" rows="5"
                                      placeholder="Please enter your response here...">{{ current_value|default:'' }}</textarea>
                        </div>

                        {% endif %}

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-4 gap-2">
                            {% if prev_item %}
                            <a href="{% url 'item_detail' prev_item.id %}" class="btn btn-outline-secondary flex-shrink-0">
                                <i class="bi bi-arrow-left d-md-none"></i>
                                <span class="d-none d-md-inline">Previous</span>
                            </a>
                            {% else %}
                            <a href="{% url 'round_overview' round_item.round.id %}" class="btn btn-outline-secondary flex-shrink-0">
                                <i class="bi bi-arrow-left d-md-none"></i>
                                <span class="d-none d-md-inline">Back to Overview</span>
                            </a>
                            {% endif %}

                            <button type="submit" class="btn btn-primary flex-grow-1 flex-md-grow-0 px-md-4">
                                Save & Continue <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Likert Scale - Responsive */
    .likert-scale-container { padding: 10px 0; }
    
    .likert-options-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: nowrap;
        gap: 5px;
    }
    
    .likert-option { 
        flex: 1; 
        min-width: 50px;
        max-width: 100px;
        padding: 5px 2px;
    }
    
    .likert-btn { 
        width: 45px; 
        height: 45px; 
        border-radius: 50% !important; 
        padding: 0; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        margin: 0 auto;
    }
    
    .likert-number { 
        color: white; 
        font-size: 1.1rem; 
        font-weight: bold; 
    }
    
    .btn-check:checked + .likert-btn { 
        transform: scale(1.1); 
        box-shadow: 0 0 10px rgba(0, 45, 114, 0.4); 
    }
    
    .likert-label { 
        font-size: 0.6rem; 
        line-height: 1.1; 
        min-height: 30px;
    }
    
    .likert-bar { height: 6px; border-radius: 3px; overflow: hidden; }
    .likert-gradient { height: 100%; background: linear-gradient(to right, #dc3545 0%, #fd7e14 25%, #6c757d 50%, #17a2b8 75%, #28a745 100%); }
    
    /* Desktop Likert Styles */
    @media (min-width: 768px) {
        .likert-scale-container { padding: 20px 0; }
        .likert-option { min-width: 80px; max-width: 120px; padding: 10px 5px; }
        .likert-btn { width: 60px; height: 60px; }
        .likert-number { font-size: 1.3rem; }
        .likert-label { font-size: 0.7rem; min-height: 35px; }
        .likert-bar { height: 8px; border-radius: 4px; }
    }
    
    @media (min-width: 992px) {
        .likert-btn { width: 70px; height: 70px; }
        .likert-number { font-size: 1.5rem; }
        .likert-label { font-size: 0.75rem; min-height: 40px; }
    }
    
    /* Option Cards */
    .option-card { transition: all 0.2s ease; cursor: pointer; }
    .option-card:hover { background-color: #f8f9fa; border-color: #002D72 !important; }
    .option-card:has(.form-check-input:checked) { background-color: #e7f1ff; border-color: #002D72 !important; border-width: 2px; }
    
    .option-label {
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    @media (min-width: 768px) {
        .option-label { font-size: 1rem; }
    }
    
    /* Matrix Table - Desktop */
    .matrix-table { font-size: 0.85rem; }
    .matrix-table th { font-weight: 600; vertical-align: middle; }
    .factor-column { width: 40%; min-width: 200px; }
    .column-header { width: 10%; min-width: 70px; font-size: 0.75rem; }
    .factor-cell { font-weight: 500; background-color: #f8f9fa; }
    .checkbox-cell { vertical-align: middle; }
    .matrix-checkbox { width: 1.1rem; height: 1.1rem; cursor: pointer; }
    .matrix-checkbox:checked { background-color: #002D72; border-color: #002D72; }
    .matrix-table tbody tr:hover { background-color: #e7f1ff; }
    
    /* Matrix Mobile Cards */
    .matrix-mobile-card .card-header {
        font-size: 0.85rem;
    }
    
    .matrix-mobile-card .form-check-label {
        font-size: 0.75rem;
    }
    
    /* Other Text Containers */
    #other-text-container, #cb-other-text-container {
        padding: 12px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    
    /* Question Prompt Responsive */
    .card-body h4 {
        font-size: 1rem;
        line-height: 1.5;
    }
    
    @media (min-width: 768px) {
        .card-body h4 {
            font-size: 1.25rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ========================================
    // MULTIPLE CHOICE - Show "Other" text box
    // ========================================
    var mcOptions = document.querySelectorAll('.mc-option');
    var otherTextContainer = document.getElementById('other-text-container');
    var otherText = document.getElementById('other-text');

    if (mcOptions.length > 0) {
        function checkOtherOption() {
            var showOther = false;
            mcOptions.forEach(function(opt) {
                if (opt.checked) {
                    var label = opt.closest('.option-card').querySelector('.form-check-label');
                    var labelText = label ? label.textContent.toLowerCase() : '';
                    if (labelText.includes('other')) {
                        showOther = true;
                    }
                }
            });
            if (otherTextContainer) {
                otherTextContainer.style.display = showOther ? 'block' : 'none';
            }
        }
        
        // Check on page load
        checkOtherOption();
        
        // Check on change
        mcOptions.forEach(function(opt) {
            opt.addEventListener('change', checkOtherOption);
        });
    }

    // ========================================
    // CHECKBOX - Show "Other" text box
    // ========================================
    var cbOptions = document.querySelectorAll('.cb-option');
    var cbOtherTextContainer = document.getElementById('cb-other-text-container');

    if (cbOptions.length > 0) {
        function checkCbOtherOption() {
            var showOther = false;
            cbOptions.forEach(function(opt) {
                if (opt.checked) {
                    var label = opt.closest('.option-card').querySelector('.form-check-label');
                    var labelText = label ? label.textContent.toLowerCase() : '';
                    if (labelText.includes('other')) {
                        showOther = true;
                    }
                }
            });
            if (cbOtherTextContainer) {
                cbOtherTextContainer.style.display = showOther ? 'block' : 'none';
            }
        }
        
        checkCbOtherOption();
        
        cbOptions.forEach(function(opt) {
            opt.addEventListener('change', checkCbOtherOption);
        });
    }

    // ========================================
    // MATRIX QUESTIONS
    // ========================================
    var matrixValue = document.getElementById('matrix-value');
    if (matrixValue) {
        var data = {};
        try { data = JSON.parse(matrixValue.value || '{}'); } catch(e) { data = {}; }

        // Pre-check saved values
        document.querySelectorAll('.matrix-checkbox').forEach(function(cb) {
            var row = cb.getAttribute('data-row');
            var col = cb.getAttribute('data-col');
            if (data[row] && data[row].indexOf(col) !== -1) {
                cb.checked = true;
            }
        });

        // Update hidden field on change
        function updateMatrixValue() {
            var newData = {};
            document.querySelectorAll('.matrix-checkbox:checked').forEach(function(checked) {
                var row = checked.getAttribute('data-row');
                var col = checked.getAttribute('data-col');
                if (!newData[row]) newData[row] = [];
                newData[row].push(col);
            });
            matrixValue.value = JSON.stringify(newData);
        }
        
        document.querySelectorAll('.matrix-checkbox').forEach(function(cb) {
            cb.addEventListener('change', updateMatrixValue);
        });

        // Update before submit
        document.getElementById('response-form').addEventListener('submit', updateMatrixValue);
    }
});
</script>
{% endblock %}